<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microbit Robot Controller</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Space Mono for that 'tech' feel -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* BBC Microbit Color Palette */
            --bg-color: #1a1a1a;
            --panel-color: #000000;
            --accent-green: #00E463; /* Microbit Logo Green */
            --accent-red: #FF0000;    /* LED Matrix Red */
            --text-color: #ffffff;
            --connector-gold: #E7A600;
        }

        body {
            font-family: 'Space Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* --- Buttons --- */
        .connect-btn {
            background-color: #333;
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            transition: all 0.3s ease;
        }
        
        .connect-btn:hover {
            background-color: var(--accent-green);
            color: black;
        }

        .connect-btn.connected {
            background-color: var(--accent-green);
            color: black;
            box-shadow: 0 0 20px var(--accent-green);
        }

        /* D-Pad Styling */
        .dpad-btn {
            background-color: #222;
            border: 2px solid #444;
            color: #666;
            transition: all 0.1s;
            font-weight: bold;
        }

        .dpad-btn.active {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
            box-shadow: 0 0 15px var(--accent-red);
            transform: scale(0.95);
        }

        /* Speaker Button */
        .speaker-btn {
            background-color: #222;
            border: 2px solid var(--connector-gold);
            color: var(--connector-gold);
            border-radius: 50%;
            transition: all 0.1s;
        }

        .speaker-btn.active {
            background-color: var(--connector-gold);
            color: black;
            transform: scale(0.90);
            box-shadow: 0 0 15px var(--connector-gold);
        }

        /* Keyboard Key Styling for Servos */
        .key-btn {
            background-color: #222;
            border: 1px solid #444;
            border-bottom: 4px solid #111; /* Key depth look */
            border-radius: 6px;
            color: white;
            transition: all 0.05s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 80px;
        }

        .key-btn:active, .key-btn.active {
            transform: translateY(3px); /* Press down effect */
            border-bottom: 1px solid #111;
            background-color: #333;
            color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 228, 99, 0.2);
            border-color: var(--accent-green);
        }

        .key-btn.close-btn:active, .key-btn.close-btn.active {
             color: var(--connector-gold);
             border-color: var(--connector-gold);
             box-shadow: 0 0 10px rgba(231, 166, 0, 0.2);
        }

        .led-dot {
            width: 8px;
            height: 8px;
            background-color: #333;
            border-radius: 2px;
        }
        .led-dot.on {
            background-color: var(--accent-red);
            box-shadow: 0 0 4px var(--accent-red);
        }

    </style>
</head>
<body class="flex flex-col h-screen max-h-screen">

    <!-- Header -->
    <header class="p-4 flex justify-between items-center border-b border-gray-800 bg-black flex-none">
        <div class="flex items-center gap-3">
            <!-- Simple Microbit Icon built with divs -->
            <div class="w-8 h-6 bg-black border border-white rounded-sm flex items-center justify-center gap-[2px]">
                <div class="led-dot on"></div>
                <div class="led-dot"></div>
                <div class="led-dot on"></div>
            </div>
            <h1 class="text-xl font-bold tracking-wider text-green-400">MICRO:BIT<span class="text-white text-sm ml-2 opacity-70">CONTROL</span></h1>
        </div>
        <button id="connectBtn" class="connect-btn px-6 py-2 rounded-md font-bold text-sm tracking-widest flex items-center gap-2">
            <span id="btIcon">âš¡</span>
            <span id="btText">CONNECT</span>
        </button>
    </header>

    <!-- Main Control Area -->
    <main class="flex-grow flex flex-col md:flex-row p-4 gap-6 items-stretch justify-center overflow-hidden">

        <!-- Left Column: D-Pad (Left) - Adjusted to w-1/2 for balance -->
        <div class="w-full md:w-1/2 flex flex-col items-center justify-center p-6 bg-black rounded-xl border border-gray-800 shadow-2xl relative order-2 md:order-1">
             <!-- Decorative Gold Edge Connector line -->
             <div class="absolute bottom-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-600 to-yellow-400 rounded-b-xl opacity-80"></div>

            <!-- Increased max-w from 340px to 500px to match servo buttons size -->
            <div class="grid grid-cols-3 grid-rows-3 gap-3 w-full max-w-[500px] aspect-square">
                <!-- Top Row -->
                <div></div>
                <button id="btnUp" class="dpad-btn rounded-t-lg flex flex-col items-center justify-center hover:bg-gray-800">
                    <span class="text-2xl">â–²</span>
                    <span class="text-[10px] opacity-50">W</span>
                </button>
                <div></div>
                
                <!-- Middle Row -->
                <button id="btnLeft" class="dpad-btn rounded-l-lg flex flex-col items-center justify-center hover:bg-gray-800">
                    <span class="text-2xl">â—€</span>
                    <span class="text-[10px] opacity-50">A</span>
                </button>
                
                <!-- Center Speaker Button -->
                <div class="flex items-center justify-center">
                    <button id="btnSpeaker" class="speaker-btn w-16 h-16 flex flex-col items-center justify-center shadow-lg" title="Horn (Spacebar)">
                        <span class="text-xl">ðŸ”Š</span>
                        <span class="text-[8px] mt-1 opacity-70">SPACE</span>
                    </button>
                </div>

                <button id="btnRight" class="dpad-btn rounded-r-lg flex flex-col items-center justify-center hover:bg-gray-800">
                    <span class="text-2xl">â–¶</span>
                    <span class="text-[10px] opacity-50">D</span>
                </button>
                
                <!-- Bottom Row -->
                <div></div>
                <button id="btnDown" class="dpad-btn rounded-b-lg flex flex-col items-center justify-center hover:bg-gray-800">
                    <span class="text-2xl">â–¼</span>
                    <span class="text-[10px] opacity-50">S</span>
                </button>
                <div></div>
            </div>
            <div class="mt-4 text-xs text-gray-500 uppercase tracking-widest text-center">DRIVE: WASD Controls</div>
        </div>

        <!-- Right Column: Servo Keyboard Grid (Right) - Adjusted to w-1/2 for balance -->
        <div class="w-full md:w-1/2 flex flex-col p-6 bg-black rounded-xl border border-gray-800 shadow-2xl relative order-1 md:order-2">
            <!-- Decorative Gold Edge Connector line -->
            <div class="absolute bottom-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-600 to-yellow-400 rounded-b-xl opacity-80"></div>
            
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <h2 class="text-xs font-bold text-gray-500 tracking-widest">MANIPULATOR ARMS</h2>
                <div class="text-[10px] text-gray-600 font-mono">CONTINUAL PRESS MODE</div>
            </div>

            <!-- Keyboard Layout Grid -->
            <!-- 4 Columns (Servos), 3 Rows (Header, Top Keys, Bottom Keys) -->
            <div class="grid grid-cols-4 gap-3 h-full pb-4">
                
                <!-- Headers -->
                <div class="text-center text-green-400 font-bold text-xs uppercase tracking-wider">SERVO 1</div>
                <div class="text-center text-green-400 font-bold text-xs uppercase tracking-wider">SERVO 2</div>
                <div class="text-center text-green-400 font-bold text-xs uppercase tracking-wider">SERVO 3</div>
                <div class="text-center text-green-400 font-bold text-xs uppercase tracking-wider">SERVO 4</div>

                <!-- Row 1: CLOSE Controls (Number Keys 7-0) -->
                <!-- Removed inline handlers, using JS for repeatable logic -->
                <button id="s1_close" class="key-btn close-btn" data-cmd="servo1close">
                    <span class="text-2xl font-bold">7</span>
                    <span class="text-[9px] opacity-50 mt-1">CLOSE</span>
                </button>

                <button id="s2_close" class="key-btn close-btn" data-cmd="servo2close">
                    <span class="text-2xl font-bold">8</span>
                    <span class="text-[9px] opacity-50 mt-1">CLOSE</span>
                </button>

                <button id="s3_close" class="key-btn close-btn" data-cmd="servo3close">
                    <span class="text-2xl font-bold">9</span>
                    <span class="text-[9px] opacity-50 mt-1">CLOSE</span>
                </button>

                <button id="s4_close" class="key-btn close-btn" data-cmd="servo4close">
                    <span class="text-2xl font-bold">0</span>
                    <span class="text-[9px] opacity-50 mt-1">CLOSE</span>
                </button>


                <!-- Row 2: OPEN Controls (Letter Keys U-P) -->
                <button id="s1_open" class="key-btn" data-cmd="servo1open">
                    <span class="text-2xl font-bold">U</span>
                    <span class="text-[9px] opacity-50 mt-1">OPEN</span>
                </button>

                <button id="s2_open" class="key-btn" data-cmd="servo2open">
                    <span class="text-2xl font-bold">I</span>
                    <span class="text-[9px] opacity-50 mt-1">OPEN</span>
                </button>

                <button id="s3_open" class="key-btn" data-cmd="servo3open">
                    <span class="text-2xl font-bold">O</span>
                    <span class="text-[9px] opacity-50 mt-1">OPEN</span>
                </button>

                <button id="s4_open" class="key-btn" data-cmd="servo4open">
                    <span class="text-2xl font-bold">P</span>
                    <span class="text-[9px] opacity-50 mt-1">OPEN</span>
                </button>

            </div>

        </div>

    </main>

    <!-- Footer / Log -->
    <footer class="p-2 bg-black border-t border-gray-900 text-center flex-none">
        <div id="statusLog" class="text-xs text-gray-500 font-mono">> WAITING FOR INPUT...</div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration ---
        const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const UART_TX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        const UART_RX_CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

        // --- State ---
        let uBitDevice;
        let rxCharacteristic;
        let connected = false;

        // --- UI Elements ---
        const connectBtn = document.getElementById('connectBtn');
        const statusLog = document.getElementById('statusLog');
        
        const btnUp = document.getElementById('btnUp');
        const btnDown = document.getElementById('btnDown');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');
        const btnSpeaker = document.getElementById('btnSpeaker');

        // --- Bluetooth Functions ---

        async function connect() {
            try {
                log("> REQUESTING DEVICE...");
                uBitDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "BBC micro:bit" }],
                    optionalServices: [UART_SERVICE_UUID]
                });

                uBitDevice.addEventListener('gattserverdisconnected', onDisconnected);

                log("> CONNECTING GATT SERVER...");
                const server = await uBitDevice.gatt.connect();

                log("> GETTING SERVICE...");
                const service = await server.getPrimaryService(UART_SERVICE_UUID);

                log("> GETTING CHARACTERISTICS...");
                const txCharacteristic = await service.getCharacteristic(UART_TX_CHARACTERISTIC_UUID);
                txCharacteristic.startNotifications();
                txCharacteristic.addEventListener("characteristicvaluechanged", onTxCharacteristicValueChanged);

                rxCharacteristic = await service.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);

                connected = true;
                updateConnectionUI();
                log("> CONNECTED_");
                
            } catch (error) {
                log("> ERROR: " + error);
                console.error(error);
            }
        }

        function disconnect() {
            if (!uBitDevice) return;
            if (uBitDevice.gatt.connected) {
                uBitDevice.gatt.disconnect();
            }
        }

        function onDisconnected(event) {
            connected = false;
            updateConnectionUI();
            log("> DISCONNECTED_");
        }

        function updateConnectionUI() {
            const btText = document.getElementById('btText');
            if (connected) {
                connectBtn.classList.add('connected');
                btText.innerText = "DISCONNECT";
            } else {
                connectBtn.classList.remove('connected');
                btText.innerText = "CONNECT";
            }
        }

        let queue = Promise.resolve();
        function queueGattOperation(operation) {
            queue = queue.then(operation, operation);
            return queue;
        }

        async function sendUART(data) {
            log("> SENDING: " + data);
            if (!connected || !rxCharacteristic) {
                console.log("Simulated Send:", data);
                return;
            }

            let encoder = new TextEncoder();
            let stringData = data + "\n"; 
            
            queueGattOperation(() => rxCharacteristic.writeValue(encoder.encode(stringData))
                .then(() => console.log("Sent:", data))
                .catch(error => console.error('Write Error:', error)));
        }

        function onTxCharacteristicValueChanged(event) {
            let receivedData = new TextDecoder().decode(event.target.value);
            console.log("RX:", receivedData);
        }

        function log(msg) {
            statusLog.innerText = msg;
        }

        connectBtn.addEventListener('click', () => {
            if (connected) disconnect();
            else connect();
        });

        // --- Continuous Sending Logic for Servos ---
        const activeServoActions = {}; // tracks interval IDs for each command

        function startServoRepeat(command, btnElement) {
            if (activeServoActions[command]) return; // Already running

            if (btnElement) btnElement.classList.add('active');

            // Send immediately once
            sendUART(command);

            // Repeat every 10ms (was 200)
            activeServoActions[command] = setInterval(() => {
                sendUART(command);
            }, 10);
        }

        function stopServoRepeat(command, btnElement) {
            if (activeServoActions[command]) {
                clearInterval(activeServoActions[command]);
                delete activeServoActions[command];
            }
            if (btnElement) btnElement.classList.remove('active');
        }

        // --- Keyboard Controls ---

        // Map keys to servo commands and button IDs
        const servoKeyMap = {
            'u': { cmd: 'servo1open', id: 's1_open' },
            '7': { cmd: 'servo1close', id: 's1_close' },
            'i': { cmd: 'servo2open', id: 's2_open' },
            '8': { cmd: 'servo2close', id: 's2_close' },
            'o': { cmd: 'servo3open', id: 's3_open' },
            '9': { cmd: 'servo3close', id: 's3_close' },
            'p': { cmd: 'servo4open', id: 's4_open' },
            '0': { cmd: 'servo4close', id: 's4_close' }
        };

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return; 

            const key = e.key.toLowerCase();

            // Check if it's a servo key
            if (servoKeyMap[key]) {
                const mapping = servoKeyMap[key];
                startServoRepeat(mapping.cmd, document.getElementById(mapping.id));
                return;
            }

            // WASD Movement (Single send on press, Stop on release)
            switch(key) {
                case "w":
                    btnUp.classList.add('active');
                    sendUART("up");
                    break;
                case "s":
                    btnDown.classList.add('active');
                    sendUART("down");
                    break;
                case "a":
                    btnLeft.classList.add('active');
                    sendUART("left");
                    break;
                case "d":
                    btnRight.classList.add('active');
                    sendUART("right");
                    break;
                case " ":
                    e.preventDefault();
                    btnSpeaker.classList.add('active');
                    sendUART("beep");
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();

            // Check if it's a servo key
            if (servoKeyMap[key]) {
                const mapping = servoKeyMap[key];
                stopServoRepeat(mapping.cmd, document.getElementById(mapping.id));
                return;
            }

            // WASD Release
            switch(key) {
                case "w":
                    btnUp.classList.remove('active');
                    sendUART("stop");
                    break;
                case "s":
                    btnDown.classList.remove('active');
                    sendUART("stop");
                    break;
                case "a":
                    btnLeft.classList.remove('active');
                    sendUART("stop");
                    break;
                case "d":
                    btnRight.classList.remove('active');
                    sendUART("stop");
                    break;
                case " ":
                    btnSpeaker.classList.remove('active');
                    break;
            }
        });

        // --- Touch/Mouse Logic for D-Pad ---
        const setupButton = (btn, commandStart, commandEnd) => {
            const start = (e) => {
                if(e.cancelable) e.preventDefault();
                btn.classList.add('active');
                sendUART(commandStart);
            };
            const end = (e) => {
                if(e.cancelable) e.preventDefault();
                btn.classList.remove('active');
                if(commandEnd) sendUART(commandEnd);
            };

            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('mouseleave', end);
            btn.addEventListener('touchstart', start);
            btn.addEventListener('touchend', end);
        };

        setupButton(btnUp, "up", "stop");
        setupButton(btnDown, "down", "stop");
        setupButton(btnLeft, "left", "stop");
        setupButton(btnRight, "right", "stop");
        setupButton(btnSpeaker, "beep", null);


        // --- Touch/Mouse Logic for Servo Buttons (Repeating) ---
        // Find all buttons with data-cmd attribute
        document.querySelectorAll('.key-btn').forEach(btn => {
            const cmd = btn.getAttribute('data-cmd');
            if(!cmd) return;

            const start = (e) => {
                if(e.cancelable) e.preventDefault();
                startServoRepeat(cmd, btn);
            };
            const end = (e) => {
                if(e.cancelable) e.preventDefault();
                stopServoRepeat(cmd, btn);
            };

            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('mouseleave', end);
            btn.addEventListener('touchstart', start);
            btn.addEventListener('touchend', end);
        });

    </script>
</body>
</html>
